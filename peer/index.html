<!DOCTYPE html>
<head>
    <script>var ip = "localhost";</script>
    
    <meta charset="utf-8">
    <title>Peer</title>
    <script>
    var browsock = {
        connect: function (address, port) {
            return new function () {
                var ws = new WebSocket("ws://" + address + ":" + port + "/app");
                var callbacks = {};
                
                ws.onmessage = function (event) {
                    var mail = JSON.parse(event.data);
                    
                    if (callbacks.hasOwnProperty(mail["message"][0])) {
                        callbacks[mail["message"][0]].apply(this, mail["data"])
                    }
                };
                
                this.send = function (message) {
                    if (ws.readyState === 1) {
                        ws.send(JSON.stringify({"message": [message], "data": Array.prototype.slice.call(arguments, 1)}))
                    }
                };
                
                this.receive = function (message, callback) {
                    callbacks[message] = callback;
                };
                
                this.disconnected = function (callback) {
                    ws.onclose = callback;
                };
            };
        }
    };
    </script>
</head>

<body style="background: white; color: black; font-family: Verdana;">

<button onclick="add()">Click</button>
<div id="disp">Not connected</div>

<script>
var disp = document.getElementById("disp");
var n = 0;
var socket = browsock.connect("localhost", "3000");

window.setTimeout(function () {
    socket.send("connected");
}, 500);

socket.receive("hey", function (greet) {
    disp.innerHTML = greet;
});

socket.receive("message", function (data) {
    n = data
    disp.innerHTML = n;
});

var add = function () {
    socket.send("message", n);
};
</script>

</body>
</html>