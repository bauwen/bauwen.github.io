<!DOCTYPE html>
<html>
<head>
    <title>Secret Message Maker</title>
    <meta charset="utf-8">
    <style>
    body {
        margin: 0px;
    }
    
    h1 {
        font: bold 32px monospace;
        margin-top: 42px;
        margin-bottom: 32px;
    }
    
    textarea {
        font: 16px sans-serif;
        padding: 8px;
        margin-right: 24px;
        margin-top: 12px;
        border: 1px solid black;
    }
    
    .box {
        display: inline-block;
    }
    
    .container {
        margin-left: 48px;
        margin-bottom: 48px;
    }
    
    #output-message, #secret-message {
        background-color: rgba(100, 200, 100, 0.1);
    }
    </style>
</head>
<body>

<div class="container">
    <h1>Secret Message Encoder</h1>

    <div class="box">
        Container Message:<br>
        <textarea id="outside-message" cols="30" rows="3" placeholder="type here..."></textarea>
    </div>
    <div class="box">
        Payload Message:<br>
        <textarea id="inside-message" cols="30" rows="3" placeholder="type here..."></textarea>
    </div>
    <div class="box">
        Output Message (copy here):<br>
        <textarea id="output-message" cols="30" rows="3" readonly></textarea>
    </div>
</div>

<hr>

<div class="container">
    <h1>Secret Message Decoder</h1>

    <div class="box">
        Input Message (paste here):<br>
        <textarea id="input-message" cols="30" rows="3" placeholder="paste message here..."></textarea>
    </div>
    <div class="box">
        Hidden Payload:<br>
        <textarea id="secret-message" cols="30" rows="3" readonly></textarea>
    </div>
</div>

<script src="lzma_worker.js"></script>
<script>
(function () {
    var nothingChars = [ "\u200B", "\u200C", "\u200D", "\u2062" ];
    var nothingBytes = [];
    for (var i = 0; i < nothingChars.length; i++) {
        var bytes = new TextEncoder("utf-8").encode(nothingChars[i]);
        nothingBytes.push(bytes[0] + (bytes[1] << 8) + (bytes[2] << 16));
    }
    var compressionFlags = [ "\u200C", "\u200D" ];
    var compressionBytes = [];
    for (var i = 0; i < compressionFlags.length; i++) {
        var bytes = new TextEncoder("utf-8").encode(compressionFlags[i]);
        compressionBytes.push(bytes[0] + (bytes[1] << 8) + (bytes[2] << 16));
    }

    function $(id) {
        return document.getElementById(id);
    }

    $("outside-message").addEventListener("input", encodeMessage);
    $("inside-message").addEventListener("input", encodeMessage);
    $("input-message").addEventListener("input", decodeMessage);

    $("output-message").addEventListener("click", function () { this.select(); });

    function encodeMessage() {
        var container = $("outside-message").value;
        var payload = $("inside-message").value;
        
        encode(container, payload, function (result) {
            $("output-message").value = result;
        });
    }

    function decodeMessage() {
        var message = $("input-message").value;
        
        decode(message, function (result) {
            $("secret-message").value = result;
            
            if ($("secret-message").value === "") {
                $("secret-message").setAttribute("placeholder", "No payload found!");
            }
        });
    }

    function encode(container, payload, callback) {
        var bytes = new TextEncoder("utf-8").encode(payload);
        var nothings = compressionFlags[0];
        
        compress(bytes, function (compressedBytes) {
            if (compressedBytes.length < bytes.length) {
                bytes = compressedBytes;
                nothings = compressionFlags[1];
            }
            
            for (var i = 0; i < bytes.length; i++) {
                nothings += byteToNothings(bytes[i]);
            }
            
            if (container.length < 2) {
                callback(container + nothings);
            } else {
                callback(container.slice(0, 1) + nothings + container.slice(1));
            }
        });
    }

    function decode(message, callback) {
        var bytes = (new TextEncoder("utf-8")).encode(message);
        var list = [];
        var i;
        
        for (i = 0; i < bytes.length - 2; i++) {
            if (isCompressionFlag(bytes[i], bytes[i + 1], bytes[i + 2])) break;
        }
        if (i === bytes.length - 2) {
            callback("");
            return;
        }
        
        var array = new Uint8Array([bytes[i], bytes[i + 1], bytes[i + 2]]);
        var flag = (new TextDecoder("utf-8")).decode(array);
        var compressed = flag === compressionFlags[1];
        
        for (i += 3; i < bytes.length - 2; i += 4 * 3) {
            if (!isNothing(bytes[i], bytes[i + 1], bytes[i + 2])) break;
            var value = 0;
            for (var k = 0; k < 4; k++) {
                var j = i + k * 3;
                var twoBits = nothingToTwoBits(bytes[j], bytes[j + 1], bytes[j + 2]);
                if (twoBits < 0) break;
                value |= twoBits << (2 * k);
            }
            list.push(value);
        }
        
        if (compressed) {
            decompress(list, function (decompressedString) {
                callback(decompressedString);
            });
        } else {
            callback((new TextDecoder("utf-8")).decode(new Uint8Array(list)));
        }
    }

    function byteToNothings(value) {
        var nothings = "";
        for (var i = 0; i < 4; i++) {
            nothings += nothingChars[(value >> (2 * i)) & 3];
        }
        return nothings;
    }

    function nothingToTwoBits(byte1, byte2, byte3) {
        return nothingBytes.indexOf(byte1 + (byte2 << 8)  + (byte3 << 16));
    }

    function isNothing(byte1, byte2, byte3) {
        return nothingToTwoBits(byte1, byte2, byte3) >= 0;
    }

    function isCompressionFlag(byte1, byte2, byte3) {
        return compressionBytes.indexOf(byte1 + (byte2 << 8)  + (byte3 << 16)) >= 0;
    }

    function compress(bytes, callback) {
        LZMA.compress(bytes, 9, function (result, error) {
            callback(error ? null : result);
        }, function (percent) {});
    }

    function decompress(bytes, callback) {
        LZMA.decompress(bytes, function (result, error) {
            callback(error ? "" : result);
        }, function (percent) {});
    }

    window.addEventListener("load", function () {
        var message = decodeURIComponent(location.search);
        if (!message) return;
        document.body.innerHTML = decode(message.slice(1));
    });
})();
</script>

</body>
</html>