<!DOCTYPE html>
<html>
<head>
    <title>Secret Message Maker</title>
    <meta charset="utf-8">
    <style>
    body {
        margin: 0px;
    }
    
    h1 {
        font: bold 32px monospace;
        margin-top: 42px;
        margin-bottom: 32px;
    }
    
    textarea {
        font: 16px sans-serif;
        padding: 8px;
        margin-right: 24px;
        margin-top: 12px;
        border: 1px solid black;
    }
    
    .box {
        display: inline-block;
    }
    
    .container {
        margin-left: 48px;
        margin-bottom: 48px;
    }
    
    #output-message, #secret-message {
        background-color: rgba(100, 200, 100, 0.1);
    }
    </style>
</head>
<body>

<div class="container">
    <h1>Secret Message Encoder</h1>

    <div class="box">
        Container Message:<br>
        <textarea id="outside-message" cols="30" rows="3" placeholder="type here..."></textarea>
    </div>
    <div class="box">
        Payload Message:<br>
        <textarea id="inside-message" cols="30" rows="3" placeholder="type here..."></textarea>
    </div>
    <div class="box">
        Output Message (copy here):<br>
        <textarea id="output-message" cols="30" rows="3" readonly></textarea>
    </div>
</div>

<hr>

<div class="container">
    <h1>Secret Message Decoder</h1>

    <div class="box">
        Input Message (paste here):<br>
        <textarea id="input-message" cols="30" rows="3" placeholder="paste message here..."></textarea>
    </div>
    <div class="box">
        Hidden Payload:<br>
        <textarea id="secret-message" cols="30" rows="3" readonly></textarea>
    </div>
</div>

<script>
var nothingChars = [ "\u200C", "\u200D", "\u202C", "\uFEFF" ];

function $(id) {
    return document.getElementById(id);
}

$("outside-message").addEventListener("input", encodeMessage);
$("inside-message").addEventListener("input", encodeMessage);
$("input-message").addEventListener("input", decodeMessage);

$("output-message").addEventListener("click", function () { this.select(); });

function encodeMessage() {
    var container = $("outside-message").value;
    var payload = $("inside-message").value;
    $("output-message").value = encmes(container, payload);
}

function decodeMessage() {
    var message = $("input-message").value;
    $("secret-message").value = decmes(message);
    
    if ($("secret-message").value === "") {
        $("secret-message").setAttribute("placeholder", "No payload found!");
    }
}

function encmes(container, payload) {
    var bytes = new TextEncoder("utf-8").encode(payload);
    var nothings = "";
    
    for (var i = 0; i < bytes.length; i++) {
        nothings += byteToNothings(bytes[i]);
    }
    
    if (container.length < 2) return container + nothings;
    return container.slice(0, 1) + nothings + container.slice(1);
}

function decmes(message) {
    var bytes = (new TextEncoder("utf-8")).encode(message);
    var list = [];
    var i;
    
    for (i = 0; i < bytes.length - 2; i++) {
        if (isNothing(bytes[i], bytes[i + 1], bytes[i + 2])) break;
    }
    if (i === bytes.length - 2) {
        return "";
    }
    
    for (; i < bytes.length - 2; i += 4 * 3) {
        if (!isNothing(bytes[i], bytes[i + 1], bytes[i + 2])) break;
        var value = 0;
        for (var k = 0; k < 4; k++) {
            var j = i + k * 3;
            var twoBits = nothingToTwoBits(bytes[j], bytes[j + 1], bytes[j + 2]);
            if (twoBits < 0) break;
            value |= twoBits << (2 * k);
        }
        list.push(value);
    }
    
    return (new TextDecoder("utf-8")).decode(new Uint8Array(list));
}

function byteToNothings(value) {
    var nothings = "";
    for (var i = 0; i < 4; i++) {
        nothings += nothingChars[(value >> (2 * i)) & 3];
    }
    return nothings;
}

function nothingToTwoBits(byte1, byte2, byte3) {
    if (byte1 === 226 && byte2 === 128) {
        if (byte3 === 140) return 0;
        if (byte3 === 141) return 1;
        if (byte3 === 172) return 2;
    }
    if (byte1 === 239 && byte2 === 187 && byte3 === 191) return 3;
    return -1;
}

function isNothing(byte1, byte2, byte3) {
    return nothingToTwoBits(byte1, byte2, byte3) >= 0;
}

window.addEventListener("load", function () {
    var message = decodeURIComponent(location.search);
    if (!message) return;
    document.body.innerHTML = decmes(message.slice(1));
});
</script>

</body>
</html>