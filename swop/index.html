<!DOCTYPE html>
<html>
<head>
    <title>Classr</title>
    <meta charset="utf-8">
    <style>
    body {
        margin: 0px;
        background-color: black;
        overflow: hidden;
    }
    
    #canvas {
        background-color: white;
    }
    </style>
</head>
<body>

<canvas id="canvas" width="400" height="240"></canvas>

<script>
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");

ctx.fillStyle = "black";
ctx.strokeStyle = "black";

var ws;
var commands = [];
var previous = [];
var mouseDown = false;

window.onload = function () {
    window.onresize();
    
    var host = "localhost";
    var index = window.location.href.indexOf('?');
    
    if (index >= 0) {
        host = window.location.href.slice(index + 1);
    }
    
    ws = new WebSocket("ws://" + host + ":3002/");
    
    ws.onmessage = function (evt) {
        var command = evt.data;
        
        if (command == "flush") {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            commands.forEach((other) => {
                draw(other);
            });
            
            previous = commands;
            commands = [];
        } else {
            commands.push(command);
        }
    };
};

window.onresize = function () {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    previous.forEach((other) => {
        draw(other);
    });
};


// Input Events (outgoing)

window.onmousedown = function (evt) {
    evt.preventDefault();
    mouseDown = true;
    
    var x = evt.pageX;
    var y = evt.pageY;
    
    ws.send("mouse clicked " + x + " " + y + " 1");
};

window.ondblclick = function (evt) {
    evt.preventDefault();
    
    var x = evt.pageX;
    var y = evt.pageY;
    
    ws.send("mouse clicked " + x + " " + y + " 2");
};

window.onmouseup = function (evt) {
    evt.preventDefault();
    mouseDown = false;
    
    var x = evt.pageX;
    var y = evt.pageY;
    
    ws.send("mouse released " + x + " " + y);
};

window.onkeypress = function (evt) {
    evt.preventDefault();
    
    var keyChar = evt.which;
    
    ws.send("key typed " + keyChar);
};

window.onkeydown = function (evt) {
    var keyCode = evt.which;
    
    if (keyCode == 13) {
        keyCode = 10;
    }
    
    if (keyCode == 46) {
        keyCode = 127;
    }
    
    ws.send("key pressed " + keyCode);
};

window.onmousemove = function (evt) {
    if (!mouseDown) {
        return;
    }
    
    var x = evt.pageX;
    var y = evt.pageY;
    
    ws.send("mouse dragged " + x + " " + y);
};


// Draw Events (incoming)

function draw(data) {
    var parts = data.split(" ");
    
    if (parts.length == 0) {
        console.log("Nothing to draw...");
        return;
    }
    
    var textHeight = 14;
    ctx.font = textHeight + "px sans-serif";
    ctx.textAlign = "start";
    
    switch (parts[0]) {
    case "rectangle":
        var x = parseInt(parts[1]);
        var y = parseInt(parts[2]);
        var width = parseInt(parts[3]);
        var height = parseInt(parts[4]);
        var filled = parts[5] == "true";
        
        drawRectangle(x, y, width, height, filled);
        break;
        
    case "circle":
        var x = parseInt(parts[1]);
        var y = parseInt(parts[2]);
        var radius = parseInt(parts[3]);
        var filled = parts[4] == "true";
        
        drawCircle(x, y, radius, filled);
        break;
        
    case "line":
        var x1 = parseInt(parts[1]);
        var y1 = parseInt(parts[2]);
        var x2 = parseInt(parts[3]);
        var y2 = parseInt(parts[4]);
        
        drawLine(x1, y1, x2, y2);
        break;
        
    case "text":
        var x = parseInt(parts[1]);
        var y = parseInt(parts[2]) + 11;
        var text = parts.slice(3, parts.length - 1).join(" ");
        var centered = parts[parts.length - 1] == "true";
        
        if (centered) {
            ctx.textAlign = "center";
            y -= textHeight / 3;
        }
        
        drawText(x, y, text);
        break;
        
    case "textstub":
        var x = parseInt(parts[1]);
        var y = parseInt(parts[2]) + 11;
        var width = parseInt(parts[3]);
        var text = parts.slice(4, parts.length - 1).join(" ");
        var right = parts[parts.length - 1] == "true";
        
        while (true) {
            var stringWidth = ctx.measureText(text).width;
            
            if (stringWidth < width) {
                break;
            }
            
            if (right) {
                text = text.slice(1);
            } else {
                text = text.slice(0, text.length - 1);
            }
        }
        
        drawText(x, y, text);
        break;
        
    case "texthighlight":
        var x = parseInt(parts[1]);
        var y = parseInt(parts[2]);
        var text = parts.slice(3, parts.length - 2).join(" ");
        var padx = parseInt(parts[parts.length - 2]);
        var pady = parseInt(parts[parts.length - 1]);
        
        var width = ctx.measureText(text).width;
        var height = textHeight;
        
        drawRectangle(x - padx, y - pady, width + padx * 2, height + pady * 2);
        drawText(x, y + 11, text);
        break;
        
    default:
        console.log("Unkown drawable '" + parts[0] + "'");
        break;
    }
}

function drawRectangle(x, y, width, height, filled) {
    if (filled) {
        ctx.fillRect(x, y, width, height);
    } else {
        ctx.strokeRect(x, y, width, height);
    }
}

function drawCircle(x, y, radius, filled) {
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, 2 * Math.PI);
    
    if (filled) {
        ctx.fill();
    } else {
        ctx.stroke();
    }
}

function drawLine(x1, y1, x2, y2) {
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
}

function drawText(x, y, text) {
    ctx.fillText(text, x, y);
}
</script>

</body>
</html>