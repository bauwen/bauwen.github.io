<!DOCTYPE html>
<head>
    <title>Controller</title>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <meta name="apple-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
    body {
        margin: 0px;
        background-color: salmon;
        overflow: hidden;
        font: 24px monospace;
    }
    
    .container {
        width: 307px;
        min-width: 307px;
        max-width: 307px;
        height: 587px;
        min-height: 587px;
        max-height: 587px;
        border: 0px solid white;
    }
    
    input {
        padding: 2px 4px;
        font: 24px monospace;
    }
    
    button {
        font: 24px monospace;
        padding: 8px 24px;
    }
    </style>
</head>
<body>

<div align="center">
    <div class="container">
        <span id="log"></span>
        <div id="lobby" style="width: 307px; height: 587px; background-color: darkorange; display: block;">
            <br><br>
            <b>IP Address:</b><br><br>
            <input id="address" type="text" size="16" value="127.0.0.1"><br><br><br><br>
            <b>Port Number:</b><br><br>
            <input id="port" type="text" size="16" value="7000"><br><br><br><br>
            <button onclick="connect()">Connect</button><br><br><br>
            <span id="error" style="color: red; font-weight: bold;"></span>
        </div>
        <canvas id="display" width="307" height="587" style="background-color: orange; display: none;"></canvas>
    </div>
</div>

<script>
function $(id) {
    return document.getElementById(id);
}

var ctx = $("display").getContext("2d");

ctx.fillStyle = "black";
ctx.strokeStyle = "black";
ctx.lineWidth = 2;

var cx = 153;
var cy = 450;
var cr = 110;

var bx = 153;
var by = 150;
var br = 60;
var bo = 80;

var ws = null;

var pressing = {
    "a": false,
    "b": false,
    "c": false,
    "d": false,
    "right": false,
    "down": false,
    "left": false,
    "up": false
};

var mouseX = 0;
var mouseY = 0;
var mouseDown = false;

var touches = [];
var rect = ctx.canvas.getBoundingClientRect();

function connect() {
    var address = $("address").value;
    var port = parseInt($("port").value);
    
    if (isNaN(port)) {
        showError();
        return;
    }
    
    ws = new WebSocket("ws://" + address + ":" + port + "/");
    
    ws.addEventListener("open", function () {
        $("lobby").style.display = "none";
        $("display").style.display = "block";
    });
    
    ws.addEventListener("error", function () {
        showError();
    });
    
    ws.addEventListener("close", function () {
        showError();
    });
    
    ws.addEventListener("message", function () {
        // not interested
    });
}

function showError() {
    if (ws) {
        ws = null;
        
        $("error").innerHTML = "Unable to connect";
        $("display").style.display = "none";
        $("lobby").style.display = "block";
    }
}

function renderBackground() {
    ctx.globalAlpha = 0.5;
    
    ctx.beginPath();
    ctx.arc(cx, cy, cr, 0, 2 * Math.PI);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(Math.PI / 4) * cr, cy - Math.sin(Math.PI / 4) * cr);
    ctx.lineTo(cx + Math.cos(5 * Math.PI / 4) * cr, cy - Math.sin(5 * Math.PI / 4) * cr);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(3 * Math.PI / 4) * cr, cy - Math.sin(3 * Math.PI / 4) * cr);
    ctx.lineTo(cx + Math.cos(7 * Math.PI / 4) * cr, cy - Math.sin(7 * Math.PI / 4) * cr);
    ctx.stroke();

    ctx.strokeRect(bx - br/2, by - bo - br/2, br, br);
    ctx.strokeRect(bx - bo - br/2, by - br/2, br, br);
    ctx.strokeRect(bx + bo - br/2, by - br/2, br, br);
    ctx.strokeRect(bx - br/2, by + bo - br/2, br, br);
}

function render() {    
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    renderBackground();
    
    var touching = {
        "a": false,
        "b": false,
        "c": false,
        "d": false,
        "right": false,
        "down": false,
        "left": false,
        "up": false
    };
    
    for (var i = 0; i < touches.length; i++) {
        var touch = touches[i];
        
        if (isInsideBox(touch.x, touch.y, bx - br/2, by - bo - br/2, br, br)) {
            touching["a"] = true;
        }
        
        if (isInsideBox(touch.x, touch.y, bx - bo - br/2, by - br/2, br, br)) {
            touching["d"] = true;
        }
        
        if (isInsideBox(touch.x, touch.y, bx + bo - br/2, by - br/2, br, br)) {
            touching["b"] = true;
        }
        
        if (isInsideBox(touch.x, touch.y, bx - br/2, by + bo - br/2, br, br)) {
            touching["c"] = true;
        }
        
        if (isInsideSector(touch.x, touch.y, cx, cy, cr, 315, 45)) {
            touching["right"] = true;
        }
        
        if (isInsideSector(touch.x, touch.y, cx, cy, cr, 225, 315)) {
            touching["down"] = true;
        }
        
        if (isInsideSector(touch.x, touch.y, cx, cy, cr, 135, 225)) {
            touching["left"] = true;
        }
        
        if (isInsideSector(touch.x, touch.y, cx, cy, cr, 45, 135)) {
            touching["up"] = true;
        }
        
        ctx.beginPath();
        ctx.arc(touch.x, touch.y, 40, 0, 2 * Math.PI);
        ctx.fill();
    }
    
    press("a", touching["a"]);
    press("b", touching["b"]);
    press("c", touching["c"]);
    press("d", touching["d"]);
    press("right", touching["right"]);
    press("down", touching["down"]);
    press("left", touching["left"]);
    press("up", touching["up"]);
    
    requestAnimationFrame(render);
}

function isInsideBox(x, y, bx, by, bw, bh) {
    return bx <= x && x < bx + bw && by <= y && y < by + bh;
}

function isInsideSector(x, y, cx, cy, cr, ang1, ang2) {
    var dis = Math.sqrt((cx - x) * (cx - x) + (cy - y) * (cy - y));
    var dir = (360 - Math.atan2(cy - y, cx - x) * 180 / Math.PI) % 360;
    
    if (ang1 < ang2) {
        return dis < cr && ang1 <= dir && dir < ang2;
    } else {
        return dis < cr && (ang1 <= dir || dir < ang2);
    }
}

function press(button, isPressing) {
    if (isPressing) {
        if (!pressing[button]) {
            sendPressed(button);
            pressing[button] = true;
        }
    } else {
        if (pressing[button]) {
            sendReleased(button);
            pressing[button] = false;
        }
    }
}

function sendPressed(button) {
    if (ws) {
        ws.send("pressed " + button);
        console.log("pressed " + button);
    }
}

function sendReleased(button) {
    if (ws) {
        ws.send("released " + button);
        console.log("released " + button);
    }
}

function updateTouches(evt) {
    touches = [];
    
    for (var i = 0; i < evt.touches.length; i++) {
        touches.push({
            x: evt.touches[i].pageX - window.scrollX - rect.left,
            y: evt.touches[i].pageY - window.scrollY - rect.top
        });
    }
    
    if (touches.length > 0)
        $("log").innerHTML = "* " + touches.length + " (" + touches[0].x + ", " + touches[0].y + ")";
}

/*
window.onmousedown = function (evt) {
    //console.log("mousedown");
    touches = [{
        x: evt.pageX - window.scrollX - rect.left,
        y: evt.pageY - window.scrollY - rect.top
    }];
};

window.onmousemove = function (evt) {
    touches = [{
        x: evt.pageX - window.scrollX - rect.left,
        y: evt.pageY - window.scrollY - rect.top
    }];
};

window.onmouseup = function (evt) {
    //console.log("mouseup");
    touches = [];
};
*/

window.ontouchstart = updateTouches;
window.ontouchend = updateTouches;
window.ontouchcancel = updateTouches;

window.ontouchmove = function (evt) {
    evt.preventDefault();
    evt.stopImmediatePropagation();
    
    updateTouches(evt);
};

window.onload = render;
</script>

</body>
</html>